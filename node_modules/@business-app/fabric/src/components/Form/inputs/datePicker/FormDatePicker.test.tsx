/*!
 * Copyright (C) Microsoft Corporation. All rights reserved.
 */

import { getTheme } from '@fluentui/react/lib/Styling';
import * as React from 'react';
import * as ReactTestUtils from 'react-dom/test-utils';

import * as Enzyme from 'enzyme';
import { Form } from '../../Form';
import { FormDatePickerBase } from './FormDatePicker.base';
import { getStyles } from './FormDatePicker.styles';

describe('FormDatePicker Unit Tests', () => {
  let wrapper: Enzyme.ReactWrapper;
  const styleProps = {
    theme: getTheme(),
    styles: getStyles
  };

  describe('Renders for all combinations of props', () => {
    it('Null name throws error', () => {
      const consoleMock = jest.spyOn(console, 'error');
      consoleMock.mockImplementation(() => undefined);

      const errorFunction = () => {
        ReactTestUtils.renderIntoDocument(
          <Form onSubmit={undefined}>
            <FormDatePickerBase {...styleProps} inputKey={null} value={undefined} />
          </Form>
        );
      };

      expect(errorFunction).toThrow();
      expect(consoleMock).toHaveBeenCalledTimes(2);
      expect((consoleMock as jest.Mock).mock.calls[0][0]).toMatch(
        'Uncaught [Error: FormBaseInput: name must be defined on all form inputs]'
      );

      consoleMock.mockRestore();
    });

    it('Null props still render', () => {
      wrapper = Enzyme.mount(
        <Form onSubmit={undefined}>
          <FormDatePickerBase {...styleProps} inputKey="name" value={undefined} validators={undefined} />
        </Form>
      );

      expect(wrapper.find('ms-DatePicker')).toBeTruthy();
    });

    it('With initial value', () => {
      let result: { name: string };
      const now: Date = new Date();
      wrapper = Enzyme.mount(
        <Form
          onSubmit={(value: { name: string }) => {
            result = value;
          }}
        >
          <FormDatePickerBase {...styleProps} inputKey="name" value={now} />
        </Form>
      );

      expect(wrapper.find('ms-DatePicker')).toBeTruthy();

      const form = wrapper.find('form');
      form.simulate('submit');

      expect(result.name).toEqual(now);
    });
  });
  describe('DatePicker update tests', () => {
    jest.useFakeTimers();

    beforeEach(() => {
      jest.useFakeTimers();
    });

    afterEach(() => {
      jest.clearAllTimers();
    });

    class ExtendsDatePicker extends FormDatePickerBase {
      public setValue(value: Date): void {
        super.setValue(value);
      }
    }

    // Disabled because of intermittent issues with timer logic.
    it.skip('DatePicker is leading and trailing debounced', done => {
      const updateStub = jest.fn();
      const formRef = React.createRef<Form>();
      ReactTestUtils.renderIntoDocument(
        <Form ref={formRef} onUpdated={updateStub}>
          <ExtendsDatePicker {...styleProps} inputKey="name" value={new Date()} />
        </Form>
      );

      const datePicker: ExtendsDatePicker = ReactTestUtils.findRenderedComponentWithType(
        formRef.current,
        ExtendsDatePicker
      );
      datePicker.setValue(new Date('2015-05-05'));
      expect(updateStub).toHaveBeenCalledTimes(1);
      datePicker.setValue(new Date('2014-05-05'));
      expect(updateStub).toHaveBeenCalledTimes(1);
      jest.runAllTimers();
      expect(updateStub).toHaveBeenCalledTimes(2);
      done();
    });
  });
});
